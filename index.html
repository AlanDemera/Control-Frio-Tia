<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Control Productos T√çA</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" href="logo.png">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#ffffff; --surface:#fbfbfb; --text:#0f172a; --muted:#6b7280;
  --red:#D32F2F; --red-600:#C12727; --green:#1E9B52; --yellow:#F59E0B;
  --card-radius:14px; --shadow: 0 8px 24px rgba(2,6,23,0.08); --gap:14px;
  font-family:'Poppins',system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);}
.app{max-width:540px;margin:0 auto;height:100vh;display:flex;flex-direction:column;padding:12px;gap:12px}

/* ======== CABECERA AJUSTADA ======== */
.header{
  display:flex;align-items:center;justify-content:space-between;gap:4px;
  padding:12px;border-radius:12px;
  background:linear-gradient(90deg,var(--red),var(--red-600));
  color:white;box-shadow:var(--shadow);
}
.brand{display:flex;align-items:center;gap:10px}
.brand img{
  width:52px;height:52px;border-radius:8px;
}
.brand .text{
  display:flex;flex-direction:column;gap:2px;
  transform:translateX(4px); /* mueve el texto un poco a la derecha */
}
.brand .title{font-size:18px;font-weight:700}
.brand .subtitle{font-size:12px;opacity:0.9}

/* ======== BOTONES M√ÅS JUNTOS ======== */
.header .btn-add{
  background:white;color:var(--red);border:none;
  padding:10px 12px;border-radius:12px;font-weight:700;font-size:15px;
  cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.08);
  margin-left:4px; /* espacio peque√±o entre botones */
}
.btn-add:active{transform:translateY(1px)}

.filters{display:flex;gap:10px;overflow-x:auto;padding-bottom:4px}
.filter-chip{flex:0 0 auto;padding:10px 14px;border-radius:999px;border:2px solid var(--red);color:var(--red);background:transparent;font-weight:600;font-size:14px;cursor:pointer;white-space:nowrap}
.filter-chip.active{background:var(--red);color:white;box-shadow:0 6px 18px rgba(209,52,52,0.12)}

.main-scroll{flex:1;overflow:auto;padding-bottom:90px;display:flex;flex-direction:column;gap:14px}
.section-title{font-size:16px;font-weight:700;margin:4px 0 8px 0;color:var(--muted)}

.input{width:100%;padding:12px;border-radius:10px;border:1px solid #eee;font-size:15px}
.input::placeholder{color:#9aa0a6}
.hint{font-size:12px;color:var(--muted)}

.product-card{background:var(--surface);border-radius:var(--card-radius);padding:14px;display:flex;justify-content:space-between;align-items:center;gap:12px;box-shadow:var(--shadow);border-left:6px solid transparent;}
.product-left{flex:1;display:flex;flex-direction:column;gap:6px}
.product-name{font-size:16px;font-weight:700}
.product-meta{font-size:13px;color:var(--muted)}

.product-card.caducado{border-left-color:var(--red)}
.product-card.proximo{border-left-color:var(--yellow)}
.product-card.vigente{border-left-color:var(--green)}

.product-actions{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
.badge{padding:6px 10px;border-radius:10px;font-weight:700;font-size:13px;color:white}
.badge.red{background:var(--red)}
.badge.yellow{background:var(--yellow);color:#222}
.badge.green{background:var(--green)}

.btn-action{padding:8px 12px;border-radius:10px;border:none;background:var(--red);color:white;font-weight:700;font-size:14px;cursor:pointer}
.btn-action.ghost{background:transparent;border:2px solid var(--red);color:var(--red);font-weight:700}

.history-card{background:#fff;border-radius:12px;padding:12px;box-shadow:var(--shadow);display:flex;justify-content:space-between;align-items:center;gap:10px}
.history-left{display:flex;flex-direction:column;gap:6px}
.small-muted{font-size:13px;color:var(--muted)}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:none;align-items:center;justify-content:center;padding:18px;z-index:50}
.modal-backdrop.show{display:flex}
.modal{width:100%;max-width:520px;background:white;border-radius:16px;padding:16px;box-shadow:0 20px 40px rgba(0,0,0,0.25)}
.modal h3{margin:0 0 8px 0;font-size:18px}
.form-field{display:flex;flex-direction:column;gap:6px;margin-bottom:8px}
.tab-btn{padding:10px 12px;border-radius:12px;border:none;background:transparent;font-weight:700;font-size:16px;cursor:pointer}
.tab-btn.active{background:linear-gradient(90deg,var(--red),var(--red-600));color:white;box-shadow:0 8px 20px rgba(209,52,52,0.12)}

@media(min-width:520px){.app{padding:18px}.product-name{font-size:18px}}
</style>

<!-- ======= FIREBASE ======= -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyAy0pN2hmOARLRrWGHdbJHI_Rm3BnfwIvE",
  authDomain: "contron-productos-tia.firebaseapp.com",
  databaseURL: "https://contron-productos-tia-default-rtdb.firebaseio.com",
  projectId: "contron-productos-tia",
  storageBucket: "contron-productos-tia.firebasestorage.app",
  messagingSenderId: "832499679175",
  appId: "1:832499679175:web:4765167b898498b86523e2"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>
</head>
<body>

<div class="app">
  <div class="header">
    <div class="brand">
      <img src="logo.png" alt="Logo T√çA">
      <div class="text">
        <div class="title">Control Productos T√çA</div>
        <div class="subtitle">Refrigerados</div>
      </div>
    </div>
    <div style="display:flex;gap:4px;">
      <button id="btnAdd" class="btn-add">‚ûï</button>
      <button id="btnHistory" class="btn-add">üìú</button>
    </div>
  </div>

  <div>
    <div class="filters" id="filters">
      <button class="filter-chip active" data-filter="all">Todos</button>
      <button class="filter-chip" data-filter="lacteos">üßÄ L√°cteos</button>
      <button class="filter-chip" data-filter="embutidos">ü•© Embutidos</button>
      <button class="filter-chip" data-filter="carnes">üçó Carnes</button>
      <button class="filter-chip" data-filter="fruver">üçé Fruver</button>
      <button class="filter-chip" data-filter="congelados">‚ùÑÔ∏è Congelados</button>
    </div>
    <div style="margin-top:10px">
      <input id="search" class="input" type="search" placeholder="üîç Buscar por nombre o c√≥digo de barra...">
    </div>
  </div>

  <div class="main-scroll" id="mainScroll">
    <section><div class="section-title">üî¥ A CADUCAR</div><div id="group-caducados" class="list-group"></div></section>
    <section><div class="section-title">üü° PR√ìXIMOS</div><div id="group-proximos" class="list-group"></div></section>
    <section><div class="section-title">üü¢ VIGENTES</div><div id="group-vigentes" class="list-group"></div></section>
  </div>
</div>

<!-- Historial -->
<div id="historyView" style="display:none">
  <div style="padding:14px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="font-weight:700;font-size:18px">üìú Historial de retirados</div>
      <button id="backToProducts" class="tab-btn" style="color:var(--red);border:2px solid var(--red)">‚¨Ö Volver</button>
    </div>
    <input id="searchHistory" class="input" type="search" placeholder="üîç Buscar en historial por nombre o c√≥digo...">
    <div id="historyList" style="display:flex;flex-direction:column;gap:10px;margin-top:10px;padding-bottom:120px"></div>
  </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <h3>Agregar producto</h3>
    <div class="form-field"><label>Nombre</label><input id="fName" class="input" type="text"></div>
    <div class="form-field"><label>C√≥digo de barra</label><input id="fCode" class="input" type="text"></div>
    <div class="form-field"><label>Categor√≠a</label>
      <select id="fCategory" class="input">
        <option value="lacteos">L√°cteos</option><option value="embutidos">Embutidos</option>
        <option value="carnes">Carnes</option><option value="fruver">Fruver</option><option value="congelados">Congelados</option>
      </select>
    </div>
    <div class="form-field"><label>Fecha de caducidad</label><input id="fExpires" class="input" type="date"></div>
    <div style="display:flex;gap:10px;margin-top:10px">
      <button id="saveBtn" class="btn-action" style="flex:1">Guardar</button>
      <button id="cancelBtn" class="btn-action ghost" style="flex:1">Cancelar</button>
    </div>
  </div>
</div>

<script>
// VARIABLES
const filters=document.querySelectorAll('.filter-chip'),
      groupCad=document.getElementById('group-caducados'),
      groupProx=document.getElementById('group-proximos'),
      groupVig=document.getElementById('group-vigentes'),
      historyList=document.getElementById('historyList'),
      search=document.getElementById('search'),
      searchHistory=document.getElementById('searchHistory');

const CATEGORIES={
  lacteos:{label:'L√°cteos',alertDays:2},
  embutidos:{label:'Embutidos',alertDays:1},
  carnes:{label:'Carnes',alertDays:2},
  fruver:{label:'Fruver',alertDays:1},
  congelados:{label:'Congelados',alertDays:1}
};

function uid(){return'm'+Math.random().toString(36).slice(2,9);}
function daysBetween(a,b){return Math.ceil((b-a)/(1000*60*60*24));}

let state={products:[],history:[]};

// FIREBASE FUNCIONES
function saveState(){db.ref('/').set(state);}
function fetchState(){
  db.ref('/').on('value', snapshot=>{
    const data=snapshot.val();
    if(data){state=data; render();}
  });
}

// STATUS
function computeStatus(p){
  const d=daysBetween(new Date(), new Date(p.expiresAt));
  const cat=CATEGORIES[p.category]||{alertDays:1};
  if(d<0) return {cls:'red',txt:`Caducado (${Math.abs(d)}d)`};
  if(d<=cat.alertDays) return {cls:'yellow',txt:`Pr√≥ximo (${d}d)`};
  return {cls:'green',txt:`Vigente (${d}d)`};
}

// RENDER
function render(){
  groupCad.innerHTML=groupProx.innerHTML=groupVig.innerHTML=historyList.innerHTML='';
  const q=search.value.toLowerCase(),f=document.querySelector('.filter-chip.active').dataset.filter;

  state.products.forEach(p=>{
    if(f!=='all'&&p.category!==f) return;
    if(q && !p.name.toLowerCase().includes(q) && !(p.code||'').includes(q)) return;

    const s=computeStatus(p);
    const div=document.createElement('div');
    div.className=`product-card ${s.cls==='red'?'caducado':s.cls==='yellow'?'proximo':'vigente'}`;
    div.innerHTML=`<div class="product-left">
      <div class="product-name">${p.name}</div>
      <div class="product-meta">C√≥digo: ${p.code||'‚Äî'} ‚Ä¢ ${CATEGORIES[p.category].label} ‚Ä¢ Caduca: ${p.expiresAt}</div>
    </div>
    <div class="product-actions">
      <div class="badge ${s.cls}">${s.txt}</div>
      <button class="btn-action">Retirar</button>
    </div>`;
    
    div.querySelector('button').onclick=()=>{
      p.retired=true;
      state.history.push({...p,retiredAt:new Date().toISOString()});
      state.products=state.products.filter(x=>!x.retired);
      saveState();
    };

    (s.cls==='red'?groupCad:s.cls==='yellow'?groupProx:groupVig).appendChild(div);
  });

  const hq=searchHistory.value.toLowerCase();
  state.history.slice().reverse().forEach(h=>{
    if(hq && !h.name.toLowerCase().includes(hq) && !(h.code||'').includes(hq)) return;
    const el=document.createElement('div');
    el.className='history-card';
    el.innerHTML=`<div class="history-left">
      <div style="font-weight:700">${h.name}</div>
      <div class="small-muted">${h.code||''}</div>
      <div class="small-muted">${CATEGORIES[h.category].label}</div>
    </div>
    <div class="small-muted">${new Date(h.retiredAt).toLocaleString()}</div>`;
    historyList.appendChild(el);
  });
}

// FILTROS
filters.forEach(c=>c.onclick=()=>{
  filters.forEach(x=>x.classList.remove('active'));
  c.classList.add('active');
  render();
});
search.oninput=searchHistory.oninput=()=>render();

// BOTONES
document.getElementById('btnHistory').onclick=()=>{document.querySelector('.app').style.display='none';document.getElementById('historyView').style.display='block';};
document.getElementById('backToProducts').onclick=()=>{document.getElementById('historyView').style.display='none';document.querySelector('.app').style.display='flex';};
document.getElementById('btnAdd').onclick=()=>document.getElementById('modalBackdrop').classList.add('show');
document.getElementById('cancelBtn').onclick=()=>document.getElementById('modalBackdrop').classList.remove('show');
document.getElementById('saveBtn').onclick=()=>{
  const n=fName.value,c=fCode.value,cat=fCategory.value,d=fExpires.value;
  if(!n||!d)return alert('Complete nombre y fecha');
  state.products.push({id:uid(),name:n,code:c,category:cat,expiresAt:d});
  saveState();
  document.getElementById('modalBackdrop').classList.remove('show');
};

// INICIO
fetchState();
</script>
</body>
</html>
