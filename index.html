<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Control Productos T√çA ‚Äî Demo</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" href="logo.png">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* ==== CSS ==== */
:root{
  --bg:#ffffff; --surface:#fbfbfb; --text:#0f172a; --muted:#6b7280;
  --red:#D32F2F; --red-600:#C12727; --green:#1E9B52; --yellow:#F59E0B;
  --card-radius:14px; --shadow: 0 8px 24px rgba(2,6,23,0.08); --gap:14px;
  font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
.app{max-width:540px;margin:0 auto;height:100vh;display:flex;flex-direction:column;padding:12px;gap:12px}

.header{display:flex;align-items:center;justify-content:space-between;gap:12px;
  padding:12px;border-radius:12px;background:linear-gradient(90deg,var(--red),var(--red-600));
  color:white;box-shadow:0 8px 24px rgba(2,6,23,0.08);
}
.brand{display:flex;flex-direction:row;align-items:center;gap:8px}
.brand img{width:36px;height:36px;border-radius:6px}
.brand .text{display:flex;flex-direction:column;gap:2px}
.brand .title{font-size:18px;font-weight:700;letter-spacing:0.2px}
.brand .subtitle{font-size:12px;opacity:0.95}

.btn-add{background:white;color:var(--red);border:none;padding:10px 14px;border-radius:12px;font-weight:700;font-size:15px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
.btn-add:active{transform:translateY(1px)}

.filters {display:flex;gap:10px;overflow-x:auto;padding-bottom:4px}
.filter-chip{flex:0 0 auto;padding:10px 14px;border-radius:999px;border:2px solid var(--red);color:var(--red);background:transparent;font-weight:600;font-size:14px;cursor:pointer;white-space:nowrap;}
.filter-chip.active{background:var(--red);color:white;box-shadow:0 6px 18px rgba(209,52,52,0.12)}

.main-scroll {flex:1;overflow:auto;padding-bottom:90px;display:flex;flex-direction:column;gap:14px;}

.section-title{font-size:16px;font-weight:700;margin:4px 0 8px 0;color:var(--muted);display:flex;align-items:center;gap:8px}

.product-card{background:var(--surface);border-radius:var(--card-radius);padding:14px;display:flex;justify-content:space-between;align-items:center;gap:12px;box-shadow:0 8px 24px rgba(2,6,23,0.08);
border-left:6px solid transparent;}
.product-left{flex:1;display:flex;flex-direction:column;gap:6px}
.product-name{font-size:16px;font-weight:700}
.product-meta{font-size:13px;color:var(--muted)}

.product-card.caducado{border-left-color:var(--red)}
.product-card.proximo{border-left-color:var(--yellow)}
.product-card.vigente{border-left-color:var(--green)}

.product-actions{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
.badge{padding:6px 10px;border-radius:10px;font-weight:700;font-size:13px;color:white}
.badge.red{background:var(--red)}
.badge.yellow{background:var(--yellow);color:#222}
.badge.green{background:var(--green)}

.btn-action{padding:8px 12px;border-radius:10px;border:none;background:var(--red);color:white;font-weight:700;font-size:14px;cursor:pointer}
.btn-action.ghost{background:transparent;border:2px solid var(--red);color:var(--red);font-weight:700}

.list-group{display:flex;flex-direction:column;gap:10px}

.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:none;align-items:center;justify-content:center;padding:18px;z-index:50}
.modal-backdrop.show{display:flex}
.modal{width:100%;max-width:520px;background:white;border-radius:16px;padding:16px;box-shadow:0 20px 40px rgba(0,0,0,0.25)}
.modal h3{margin:0 0 8px 0;font-size:18px}
.form-field{display:flex;flex-direction:column;gap:6px;margin-bottom:8px}
.input{padding:12px;border-radius:10px;border:1px solid #eee;font-size:15px}
.input::placeholder{color:#9aa0a6}
.hint{font-size:12px;color:var(--muted)}

.tabbar{position:fixed;left:0;right:0;bottom:0;display:flex;justify-content:space-between;gap:12px;padding:12px;background:white;border-top:1px solid #f0f0f0}
.tab-btn{flex:1;padding:12px;border-radius:12px;border:none;background:transparent;font-weight:700;font-size:16px;cursor:pointer}
.tab-btn.active{background:linear-gradient(90deg,var(--red),var(--red-600));color:white;box-shadow:0 8px 20px rgba(209,52,52,0.12)}

.history-card{background:#fff;border-radius:12px;padding:12px;box-shadow:0 8px 24px rgba(2,6,23,0.08);display:flex;justify-content:space-between;align-items:center;gap:10px}
.history-left{display:flex;flex-direction:column;gap:6px}
.small-muted{font-size:13px;color:var(--muted)}

@media(min-width:520px){.app{padding:18px}.product-name{font-size:18px}}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="brand">
      <img src="logo.png" alt="Logo T√çA">
      <div class="text">
        <div class="title">Control Productos T√çA</div>
        <div class="subtitle">Refrigerados ‚Äî Demo Funcional</div>
      </div>
    </div>
    <button id="btnAdd" class="btn-add">‚ûï Agregar</button>
  </div>

  <div>
    <div class="filters" id="filters">
      <button class="filter-chip active" data-filter="all">Todos</button>
      <button class="filter-chip" data-filter="lacteos">üßÄ L√°cteos</button>
      <button class="filter-chip" data-filter="embutidos">ü•© Embutidos</button>
      <button class="filter-chip" data-filter="carnes">üçó Carnes</button>
      <button class="filter-chip" data-filter="fruver">üçé Fruver</button>
      <button class="filter-chip" data-filter="congelados">‚ùÑÔ∏è Congelados</button>
    </div>
    <div style="margin-top:10px">
      <input id="search" class="input" type="search" placeholder="Buscar por nombre o c√≥digo">
      <div class="hint" style="margin-top:6px">Los productos caducados aparecen primero.</div>
    </div>
  </div>

  <div class="main-scroll" id="mainScroll">
    <section>
      <div class="section-title">üî¥ A CADUCAR</div>
      <div id="group-caducados" class="list-group"></div>
    </section>
    <section>
      <div class="section-title">üü° PR√ìXIMOS</div>
      <div id="group-proximos" class="list-group"></div>
    </section>
    <section>
      <div class="section-title">üü¢ VIGENTES</div>
      <div id="group-vigentes" class="list-group"></div>
    </section>
  </div>
</div>

<div style="display:none" id="historyView">
  <div style="padding:14px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="font-weight:700;font-size:18px">üìú Historial de retirados</div>
      <button id="backToProducts" class="tab-btn" style="flex:0;background:transparent;border-radius:8px;padding:8px 10px;color:var(--red);border:2px solid var(--red)">‚¨Ö Volver</button>
    </div>
    <div id="historyList" style="display:flex;flex-direction:column;gap:10px;padding-bottom:120px"></div>
  </div>
</div>

<div class="modal-backdrop" id="modal">
  <div class="modal">
    <h3>Agregar producto</h3>
    <div class="form-field">
      <label class="hint">Nombre</label>
      <input id="fName" class="input" type="text" placeholder="Ej. Leche entera 1L">
    </div>
    <!-- NUEVO CAMPO: C√ìDIGO DE BARRA -->
    <div class="form-field">
      <label class="hint">C√≥digo de barra</label>
      <input id="fBarcode" class="input" type="text" placeholder="Ej. 1234567890123">
    </div>

    <div class="form-field">
      <label class="hint">Categor√≠a</label>
      <select id="fCategory" class="input">
        <option value="lacteos">L√°cteos</option>
        <option value="embutidos">Embutidos</option>
        <option value="carnes">Carnes</option>
        <option value="fruver">Fruver</option>
        <option value="congelados">Congelados</option>
      </select>
    </div>
    <div class="form-field">
      <label class="hint">Fecha de caducidad</label>
      <input id="fExpires" class="input" type="date">
      <div class="small-muted" id="daysLeft">‚Äî d√≠as</div>
    </div>
    <div style="display:flex;gap:10px;margin-top:10px">
      <button id="saveBtn" class="btn-action" style="flex:1">Guardar</button>
      <button id="cancelBtn" class="btn-action ghost" style="flex:1">Cancelar</button>
    </div>
  </div>
</div>

<div class="tabbar">
  <button class="tab-btn active" id="tabProducts">Productos</button>
  <button class="tab-btn" id="tabHistory">Historial</button>
</div>

<!-- ===== APP + FIREBASE (moderno, type="module") ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import {
    getDatabase,
    ref,
    set,
    push,
    onValue,
    update,
    remove
  } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

  // ====== TU CONFIG (la que compartiste) ======
  const firebaseConfig = {
    apiKey: "AIzaSyAy0pN2hmOARLRrWGHdbJHI_Rm3BnfwIvE",
    authDomain: "contron-productos-tia.firebaseapp.com",
    databaseURL: "https://contron-productos-tia-default-rtdb.firebaseio.com",
    projectId: "contron-productos-tia",
    storageBucket: "contron-productos-tia.firebasestorage.app",
    messagingSenderId: "832499679175",
    appId: "1:832499679175:web:4765167b898498b86523e2"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ====== CONSTANTES / DOM ======
  const CATEGORIES = {
    lacteos:{label:'L√°cteos', alertDays:2},
    embutidos:{label:'Embutidos', alertDays:1},
    carnes:{label:'Carnes', alertDays:2},
    fruver:{label:'Fruver', alertDays:1},
    congelados:{label:'Congelados', alertDays:1}
  };

  function daysBetween(a,b){return Math.ceil((Date.UTC(b.getFullYear(),b.getMonth(),b.getDate())-Date.UTC(a.getFullYear(),a.getMonth(),a.getDate()))/(24*60*60*1000));}
  function uid(){return 'p_'+Math.random().toString(36).slice(2,9);}

  let state = { products: [], history: [] };

  const groupCad = document.getElementById('group-caducados');
  const groupProx = document.getElementById('group-proximos');
  const groupVig = document.getElementById('group-vigentes');
  const historyList = document.getElementById('historyList');
  const mainScroll = document.getElementById('mainScroll');
  const modal = document.getElementById('modal');
  const btnAdd = document.getElementById('btnAdd');
  const cancelBtn = document.getElementById('cancelBtn');
  const saveBtn = document.getElementById('saveBtn');
  const backToProducts = document.getElementById('backToProducts');
  const historyView = document.getElementById('historyView');
  const fName = document.getElementById('fName');
  const fCategory = document.getElementById('fCategory');
  const fExpires = document.getElementById('fExpires');
  const fBarcode = document.getElementById('fBarcode');
  const daysLeft = document.getElementById('daysLeft');
  const searchInput = document.getElementById('search');
  const filterChips = document.querySelectorAll('.filter-chip');
  const tabProducts = document.getElementById('tabProducts');
  const tabHistory = document.getElementById('tabHistory');

  // ====== UTILIDADES ======
  function computeStatus(p){
    const today=new Date();
    const exp=new Date(p.expiresAt);
    const d=daysBetween(today,exp);
    const cat=CATEGORIES[p.category]||{alertDays:1};
    if(d<0) return {label:`Caducado (${Math.abs(d)}d)`, cls:'red'};
    if(d<=cat.alertDays) return {label:`Pr√≥ximo (${d}d)`, cls:'yellow'};
    return {label:`Vigente (${d}d)`, cls:'green'};
  }

  function createProductCard(p,st){
    const card=document.createElement('div');
    card.className='product-card '+(st.cls==='red'?'caducado':st.cls==='yellow'?'proximo':'vigente');
    const left=document.createElement('div'); left.className='product-left';
    left.innerHTML=`<div class="product-name">${p.name}</div>
      <div class="product-meta">${CATEGORIES[p.category]?.label||p.category} ‚Ä¢ Caduca: ${p.expiresAt}${p.barcode ? ' ‚Ä¢ C√≥digo: '+p.barcode : ''}</div>`;
    const actions=document.createElement('div'); actions.className='product-actions';
    const badge=document.createElement('div'); badge.className='badge '+st.cls; badge.textContent=st.label;
    actions.appendChild(badge);
    if(!p.retired){
      const btn=document.createElement('button'); btn.className='btn-action'; btn.textContent='Retirar';
      btn.onclick=()=>{ retireProduct(p); };
      actions.appendChild(btn);
    }
    card.appendChild(left); card.appendChild(actions); return card;
  }

  // ====== RENDER ======
  function renderProducts(){
    groupCad.innerHTML=''; groupProx.innerHTML=''; groupVig.innerHTML='';
    const q=searchInput.value.trim().toLowerCase();
    const activeFilter=document.querySelector('.filter-chip.active')?.dataset.filter||'all';
    const cad=[], prox=[], vig=[];
    (state.products||[]).forEach(p=>{
      if(activeFilter!=='all'&&p.category!==activeFilter) return;
      if(q && !(p.name.toLowerCase().includes(q) || (p.barcode && p.barcode.includes(q)))) return;
      const st=computeStatus(p);
      const card=createProductCard(p,st);
      if(st.cls==='red') cad.push(card);
      else if(st.cls==='yellow') prox.push(card);
      else vig.push(card);
    });
    cad.forEach(c=>groupCad.appendChild(c));
    prox.forEach(c=>groupProx.appendChild(c));
    vig.forEach(c=>groupVig.appendChild(c));
    if(!groupCad.hasChildNodes()) groupCad.innerHTML=`<div class="hint small-muted">No hay productos caducados</div>`;
    if(!groupProx.hasChildNodes()) groupProx.innerHTML=`<div class="hint small-muted">No hay pr√≥ximos productos</div>`;
    if(!groupVig.hasChildNodes()) groupVig.innerHTML=`<div class="hint small-muted">No hay productos vigentes</div>`;
  }

  function renderHistory(){
    historyList.innerHTML='';
    (state.history||[]).slice().reverse().forEach(h=>{
      const el=document.createElement('div'); el.className='history-card';
      el.innerHTML=`<div class="history-left"><div style="font-weight:700">${h.name}</div><div class="small-muted">${CATEGORIES[h.category]?.label||h.category}</div></div>
                    <div class="small-muted">${new Date(h.retiredAt).toLocaleString()}</div>`;
      historyList.appendChild(el);
    });
    if(!historyList.hasChildNodes()) historyList.innerHTML=`<div class="hint small-muted">A√∫n no hay historial</div>`;
  }

  // ====== FIREBASE: guardado y lectura ======
  // Guardar/actualizar producto por id
  function saveProductToFirebase(p){
    // p must contain .id
    set(ref(db, 'products/' + p.id), p);
  }

  // A√±adir entrada al historial (push)
  function pushHistoryToFirebase(h){
    const histRef = ref(db, 'history');
    const newRef = push(histRef);
    set(newRef, h);
  }

  // Retirar producto: marcar producto como retirado y agregar a history
  function retireProduct(p){
    p.retired = true;
    p.retiredAt = new Date().toISOString();
    // actualizar producto
    saveProductToFirebase(p);
    // push al historial
    pushHistoryToFirebase({...p});
    // mostrar cambios de forma local
    renderProducts();
    renderHistory();
    mainScroll.scrollTo({top:0,behavior:'smooth'});
  }

  // Escuchar productos en tiempo real
  const productsRef = ref(db, 'products');
  onValue(productsRef, snapshot => {
    const val = snapshot.val() || {};
    // val es un objeto con llaves = id
    // convertimos a array
    const arr = Object.keys(val).map(k => val[k]);
    state.products = arr;
    // renderizar solo si estamos en la pesta√±a de productos
    if (mainScroll.style.display !== 'none') renderProducts();
  });

  // Escuchar historial en tiempo real
  const historyRef = ref(db, 'history');
  onValue(historyRef, snapshot => {
    const val = snapshot.val() || {};
    // val es un objeto con llaves pushId
    const arr = Object.keys(val).map(k => val[k]);
    state.history = arr;
    if (historyView.style.display !== 'none') renderHistory();
  });

  // ====== EVENTOS UI ======
  filterChips.forEach(chip=>{chip.addEventListener('click',()=>{filterChips.forEach(c=>c.classList.remove('active')); chip.classList.add('active'); renderProducts(); mainScroll.scrollTo({top:0,behavior:'smooth'});});});
  searchInput.addEventListener('input',()=>renderProducts());

  btnAdd.addEventListener('click',()=>{modal.classList.add('show'); fName.value=''; fBarcode.value=''; fCategory.value='lacteos'; fExpires.value=''; daysLeft.textContent='‚Äî d√≠as'; fName.focus();});
  cancelBtn.addEventListener('click',()=>modal.classList.remove('show'));

  fExpires.addEventListener('change',()=>{const v=fExpires.value;if(!v){daysLeft.textContent='‚Äî d√≠as';return;}daysLeft.textContent=daysBetween(new Date(),new Date(v))+' d√≠a(s)';});

  saveBtn.addEventListener('click',()=>{
    const name=fName.value.trim(); const category=fCategory.value; const expiresAt=fExpires.value; const barcode=fBarcode.value.trim();
    if(!name||!expiresAt){alert('Nombre y fecha de caducidad obligatorios'); return;}
    const newProduct = { id: uid(), name, category, expiresAt, barcode: barcode||'', retired:false };
    // Guardar en firebase
    saveProductToFirebase(newProduct);
    modal.classList.remove('show');
    // actualizamos la UI local (se actualizar√° tambi√©n cuando el listener reciba el cambio)
    renderProducts();
  });

  tabProducts.addEventListener('click',()=>{mainScroll.style.display='flex'; historyView.style.display='none'; tabProducts.classList.add('active'); tabHistory.classList.remove('active'); renderProducts();});
  tabHistory.addEventListener('click',()=>{mainScroll.style.display='none'; historyView.style.display='flex'; tabHistory.classList.add('active'); tabProducts.classList.remove('active'); renderHistory();});
  backToProducts.addEventListener('click',()=>{tabProducts.click();});

  // ====== INIT ======
  renderProducts();
</script>
</body>
</html>
